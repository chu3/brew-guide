'use client'

import React, { useState, useRef, useEffect } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import Image from 'next/image'

/**
 * ÊûÅÁÆÄ‰∏ãËΩΩÈ°µÈù¢ÁªÑ‰ª∂
 */
export default function DownloadPage(): React.ReactNode {
    const [showContent, setShowContent] = useState(false)
    const [activeTab, setActiveTab] = useState<'intro' | 'download' | 'changelog'>('intro')
    const [imageIndex, setImageIndex] = useState(0)
    const scrollRef = useRef<HTMLDivElement>(null)
    
    const images = [
        '/images/content/ËæÖÂä©ÂÜ≤ÁÖÆÂèØËßÜÂåñÊà™Âõæ.PNG',
        '/images/content/Ë±Ü‰ªìÊà™Âõæ.PNG',
        '/images/content/Á¨îËÆ∞ÂàóË°®Êà™Âõæ.PNG',
        '/images/content/‰∏™‰∫∫Ê¶úÂçïÊà™Âõæ.PNG',
        '/images/content/Êï∞ÊçÆÁªüËÆ°Êà™Âõæ.PNG',
        '/images/content/ÈöèÊú∫ÈÄâË±ÜÊà™Âõæ.PNG',
        '/images/content/ÊñπÊ°àÂàóË°®Êà™Âõæ.PNG',
        '/images/content/ÂÜ≤ÁÖÆÊñπÊ°àÊ≠•È™§Êà™Âõæ.PNG',
        '/images/content/Âçö‰∏ªÊ¶úÂçïÊà™Âõæ.PNG',
    ]
    
    const descriptions = [
        "ÂèØËßÜÂåñËæÖÂä©ÂÜ≤ÁÖÆÔºåËÆ©ÊØè‰∏ÄÊ¨°ÂÜ≤ÁÖÆÈÉΩÊõ¥Á≤æÂáÜ„ÄÇ",
        "ÁÆ°ÁêÜ‰Ω†ÁöÑÂíñÂï°Ë±ÜÂ∫ìÂ≠òÔºåËÆ∞ÂΩïÊØè‰∏ÄÈ¢óË±ÜÂ≠ê„ÄÇ",
        "ËÆ∞ÂΩïÊØèÊ¨°ÂÜ≤ÁÖÆÁöÑËØ¶ÁªÜÁ¨îËÆ∞ÂíåÊÑüÂèó„ÄÇ",
        "‰∏™‰∫∫ÂíñÂï°Ë±ÜËØÑÂàÜÊ¶úÂçïÔºåÂèëÁé∞ÊúÄÁà±„ÄÇ",
        "ËØ¶ÁªÜÁöÑÂÜ≤ÁÖÆÊï∞ÊçÆÁªüËÆ°ÂíåÂàÜÊûê„ÄÇ",
        "‰ªäÂ§©Âñù‰ªÄ‰πàË±ÜÂ≠êÔºüËÆ©ÈöèÊú∫ÈÄâÊã©Â∏Æ‰Ω†ÂÜ≥ÂÆö„ÄÇ",
        "‰∏∞ÂØåÁöÑÂÜ≤ÁÖÆÊñπÊ°àÂ∫ìÔºåÊé¢Á¥¢‰∏çÂêåÁöÑÂÜ≤ÁÖÆÊñπÊ≥ï„ÄÇ",
        "ËØ¶ÁªÜÁöÑÂÜ≤ÁÖÆÊ≠•È™§ÊåáÂØºÔºåÊñ∞Êâã‰πüËÉΩËΩªÊùæ‰∏äÊâã„ÄÇ",
        "ÂèëÁé∞‰ºòË¥®ÂíñÂï°Ë±ÜÔºåÊé¢Á¥¢Âçö‰∏ªÊé®Ëçê„ÄÇ",
    ]

    // ÂÜÖÂÆπÂàáÊç¢Â§ÑÁêÜÂáΩÊï∞
    const handleTabClick = (tab: 'intro' | 'download' | 'changelog') => {
        setShowContent(true)
        setActiveTab(tab)
    }

    // ÁõëÂê¨ÊªöÂä®ÔºåÊõ¥Êñ∞ÂΩìÂâçÊòæÁ§∫ÁöÑÂõæÁâáÁ¥¢Âºï
    useEffect(() => {
        const scrollElement = scrollRef.current
        if (!scrollElement || !showContent) return

        const handleScroll = () => {
            if (!scrollElement) return
            
            const scrollPosition = scrollElement.scrollLeft
            const containerWidth = scrollElement.clientWidth
            
            // ËÆ°ÁÆóÂΩìÂâçÂèØËßÅÁöÑÂõæÁâáÁ¥¢Âºï
            // ÂØπ‰∫éÂÆΩÂ∫¶‰∏∫85%ÁöÑÂõæÁâáÔºåÊØè‰∏™ÂõæÁâáÂç†ÊçÆÂ§ßÁ∫¶85%ÁöÑÂÆπÂô®ÂÆΩÂ∫¶Ôºå‰ΩÜ‰∏é‰∏ã‰∏ÄÂº†ÊúâÈáçÂè†
            let index = 0;
            
            if (images.length > 1) {
                // ‰º∞ÁÆóÊØè‰∏™ÂõæÁâáÁöÑÂÆûÈôÖÂÆΩÂ∫¶Âíå‰ΩçÁΩÆ
                const slideWidth = containerWidth * 0.85; // 85% ÁöÑÂÆπÂô®ÂÆΩÂ∫¶
                const effectiveWidth = slideWidth - 50; // ÂáèÂéªÈáçÂè†ÈÉ®ÂàÜ
                
                // Ê†πÊçÆÊªöÂä®‰ΩçÁΩÆËÆ°ÁÆóÂΩìÂâçÁ¥¢Âºï
                index = Math.round(scrollPosition / effectiveWidth);
                
                // Á°Æ‰øùÁ¥¢ÂºïÂú®ÊúâÊïàËåÉÂõ¥ÂÜÖ
                index = Math.max(0, Math.min(index, images.length - 1));
            }
            
            if (index !== imageIndex) {
                setImageIndex(index);
            }
        }

        // ÂàùÂßãÂåñÊó∂ÊâßË°å‰∏ÄÊ¨°
        handleScroll();

        scrollElement.addEventListener('scroll', handleScroll)
        return () => {
            scrollElement.removeEventListener('scroll', handleScroll)
        }
    }, [showContent, images.length, imageIndex])

    // Ê∏≤Êüì‰∏çÂêåÊ†áÁ≠æÈ°µÁöÑÂÜÖÂÆπ
    const renderTabContent = () => {
        switch (activeTab) {
            case 'intro':
                return (
                    <motion.div
                        key="intro"
                        initial={{ opacity: 0, scale: 0.98 }}
                        animate={{ opacity: 1, scale: 1 }}
                        exit={{ opacity: 0, scale: 0.98 }}
                        transition={{ duration: 0.3 }}
                        className="w-full"
                    >
                        <div 
                            ref={scrollRef}
                            className="w-full overflow-x-auto overflow-y-hidden snap-x snap-mandatory flex scrollbar-none [scrollbar-width:none] [-ms-overflow-style:none]"
                            style={{ scrollbarWidth: 'none' }}
                        >
                            <style jsx>{`
                                div::-webkit-scrollbar {
                                    display: none;
                                }
                            `}</style>
                            {images.map((image, index) => (
                                <motion.div 
                                    key={index}
                                    className={`${
                                        index === images.length - 1 
                                            ? 'w-full' 
                                            : 'w-[85%] mr-[-50px]'
                                    } flex-shrink-0 snap-start relative`}
                                    initial={{ opacity: 0, filter: 'blur(10px)' }}
                                    animate={{ opacity: 1, filter: 'blur(0px)' }}
                                    transition={{ delay: index * 0.1, duration: 0.3 }}
                                >
                                    <div className="relative w-full h-[65vh] flex items-center justify-start pl-6">
                                        <div className="relative inline-block">
                                            <Image 
                                                src={image}
                                                alt={`App screenshot ${index + 1}`}
                                                className="object-contain max-h-[60vh] w-auto"
                                                width={300}
                                                height={600}
                                                priority
                                            />
                                            
                                            {/* ÂõæÁâáÂ∫èÂè∑ÊåáÁ§∫Âô® - Â∑¶‰∏ãËßí */}
                                            <div className="absolute -bottom-5 left-0 rounded-full text-xs text-neutral-500">
                                                {index + 1}
                                            </div>
                                        </div>
                                    </div>
                                </motion.div>
                            ))}
                        </div>
                    </motion.div>
                );
            case 'download':
                return (
                    <motion.div 
                        key="download"
                        className="w-full h-[65vh] flex flex-col items-start justify-start pl-6 pr-6"
                        initial={{ opacity: 0, scale: 0.98 }}
                        animate={{ opacity: 1, scale: 1 }}
                        exit={{ opacity: 0, scale: 0.98 }}
                        transition={{ duration: 0.3 }}
                    >
                        <h2 className="text-lg font-medium mb-6 mt-20">‰∏ãËΩΩÈìæÊé•</h2>
                        <div className="flex flex-col gap-6 text-sm">
                            <a 
                                href="https://www.123912.com/s/prGKTd-HpJWA" 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="flex items-center gap-2 hover:opacity-70 transition-opacity"
                            >
                                <div className="flex items-center whitespace-nowrap">
                                    <span className="text-neutral-800 dark:text-neutral-200">üîó ÂõΩÂÜÖ‰∏ãËΩΩ</span>
                                </div>
                                <span className="text-xs text-neutral-500 truncate">(https://www.123912.com/s/prGKTd-HpJWA)</span>
                            </a>
                            <a 
                                href="https://github.com/chu3/brew-guide/releases" 
                                target="_blank"
                                rel="noopener noreferrer"
                                className="flex items-center gap-2 hover:opacity-70 transition-opacity"
                            >
                                <div className="flex items-center whitespace-nowrap">
                                    <span className="text-neutral-800 dark:text-neutral-200">üîó Êµ∑Â§ñ‰∏ãËΩΩ</span>
                                </div>
                                <span className="text-xs text-neutral-500 truncate">(https://github.com/chu3/brew-guide/releases)</span>
                            </a>
                        </div>
                    </motion.div>
                );
            case 'changelog':
                return (
                    <motion.div 
                        key="changelog"
                        className="w-full h-[65vh] flex flex-col items-start justify-start pl-6 pr-6 relative bg-neutral-50 dark:bg-neutral-900"
                        initial={{ opacity: 0, scale: 0.98 }}
                        animate={{ opacity: 1, scale: 1 }}
                        exit={{ opacity: 0, scale: 0.98 }}
                        transition={{ duration: 0.3 }}
                    >
                        <div className="absolute top-0 left-0 w-full h-[120px] bg-gradient-to-b from-neutral-50 dark:from-neutral-900 to-transparent z-[1] pointer-events-none" />
                        
                        <div className="w-full h-full overflow-y-auto scrollbar-none relative" 
                             style={{ scrollbarWidth: 'none' }}>
                            <style jsx>{`
                                div::-webkit-scrollbar {
                                    display: none;
                                }
                            `}</style>
                            
                            <div className="flex flex-col gap-6 text-sm pb-20 pt-20">
                                <h2 className="text-lg font-medium mb-6">Êõ¥Êñ∞ËÆ∞ÂΩï</h2>
                                
                                <div>
                                    <p className="font-medium">Âç≥Â∞ÜÂèëÂ∏ÉÁöÑÊõ¥Êñ∞ÔºàÂ∞öÊú™Êé®ÈÄÅÔºâ</p>
                                    <ul className="mt-2 text-xs text-neutral-500 list-disc pl-4 space-y-1">
                                        <li>‰øÆÂ§çÔºöÁ¨îËÆ∞ÊêúÁ¥¢ÂäüËÉΩÂ§±ÊïàÈóÆÈ¢ò <span className="text-xs opacity-70">chu3 ¬© main</span></li>
                                        <li>‰ºòÂåñÔºöË∞ÉÊï¥ÂÆâÂÖ®Âå∫ÂüüÁöÑÂ°´ÂÖÖÂíå‰ΩçÁΩÆÔºå‰ª•ÊîπÂñÑÁïåÈù¢ÈÄÇÂ∫îÊÄß <span className="text-xs opacity-70">chus</span></li>
                                        <li>‰øÆÂ§çÔºöÊõøÊç¢Êï∞ÊçÆÊó∂ÔºåËá™ÂÆö‰πâÂô®ÂÖ∑Ê≤°ÊúâÊ≠£Â∏∏Êõ¥Êñ∞ <span className="text-xs opacity-70">chu3</span></li>
                                        <li>‰ºòÂåñÔºöÂ∞ÜÂÜ∞ÊâãÂÜ≤ÂíñÂï°Á†îÁ£®Â§ßÂ∞è‰ªé"ÁªÜ"Ë∞ÉÊï¥‰∏∫"‰∏≠ÁªÜ" <span className="text-xs opacity-70">chu3</span></li>
                                        <li>Êõ¥Êñ∞ËµûÂä©Ê¶ú <span className="text-xs opacity-70">chu3</span></li>
                                    </ul>
                                </div>
                                
                                <div>
                                    <p className="font-medium">v1.2.4.5ÔºàÊúÄÊñ∞ÁâàÊú¨Ôºâ</p>
                                    <p className="text-xs text-neutral-500 mt-1">2025-05-12</p>
                                    <ul className="mt-2 text-xs text-neutral-500 list-disc pl-4 space-y-1">
                                        <li>Êñ∞Â¢ûÈöèÊú∫ÈÄâÊã©ÂíñÂï°Ë±ÜÂäüËÉΩ "‰ªäÂ§©Âñù‰ªÄ‰πàË±ÜÂ≠ê"</li>
                                        <li>ÂõæÁâá‰∏ä‰º†Êó∂Ëá™Âä®ÂéãÁº©ÔºàÂ∞è‰∫é200KB‰øùÁïôÂéüÂõæÔºâ</li>
                                        <li>Âø´Êç∑Êâ£Èô§Â∫ìÂ≠ò‰πü‰ºöËá™Âä®ÂàõÂª∫ÂÜ≤ÁÖÆÁ¨îËÆ∞</li>
                                        <li>Ëá™ÂÆö‰πâÂÜ≤ÁÖÆÊñπÊ°àÊï∞ÊçÆÊåÅ‰πÖÂåñÔºåÂà∑Êñ∞È°µÈù¢‰∏ç‰∏¢Â§±</li>
                                        <li>ÂàÜÁ±ªÊåâÈíÆÂ∏ÉÂ±ÄÊõ¥Á¥ßÂáë</li>
                                        <li>È£éÂë≥ËØÑÂàÜÁ¨îËÆ∞Âú®ÊúâËØÑ‰ª∑Êó∂Ëá™Âä®Â±ïÂºÄ</li>
                                        <li>ÂíñÂï°Ë±ÜË°®ÂçïËæìÂÖ•ÈôêÂà∂Â∞èÊï∞ÁÇπÂêé‰∏Ä‰Ωç</li>
                                        <li>‰øÆÂ§çÂÜ≤ÁÖÆÂÆåÊàêÂêéÂíñÂï°Ë±ÜÁªëÂÆöÈîôËØØÈóÆÈ¢ò</li>
                                        <li>‰øÆÂ§çÂà†Èô§ÂíñÂï°Ë±ÜÂêéÁªüËÆ°‰ø°ÊÅØÊÆãÁïôÈóÆÈ¢ò</li>
                                    </ul>
                                </div>
                                
                                <div>
                                    <p className="font-medium">v1.2.4.4</p>
                                    <p className="text-xs text-neutral-500 mt-1">2025-05-08</p>
                                    <ul className="mt-2 text-xs text-neutral-500 list-disc pl-4 space-y-1">
                                        <li>‰øÆÂ§çÂ§öÈ°πÈóÆÈ¢òÔºöÂíñÂï°Ë±ÜÂØºÂÖ•ÂºÇÂ∏∏„ÄÅÊàêÂàÜ‰ø°ÊÅØ‰∏¢Â§±„ÄÅÁ≠õÈÄâÊ†èÂè≥‰æß‰∏çÂèØÁÇπÂáªÁ≠â</li>
                                        <li>‰øÆÂ§çÁ¨îËÆ∞‰øùÂ≠òÂ§±Ë¥•Êä•Èîô‰ø°ÊÅØ‰∏çÊòéÁ°ÆÈóÆÈ¢ò</li>
                                        <li>‰øÆÂ§çËÆ°Êó∂Âô®ÂÄíËÆ°Êó∂Èü≥ÊïàÁº∫Â§±‰∏éÈ¢ëÁπÅÊìç‰ΩúÂºÇÂ∏∏</li>
                                        <li>ËÆæÁΩÆÈ°µÈù¢ÊîπÁâà</li>
                                        <li>ÊâãÂä®Ê∑ªÂä†Á¨îËÆ∞ÁïåÈù¢Áªü‰∏Ä</li>
                                        <li>ÂíñÂï°Ë±ÜÂàóË°®‰∏çÂêå‰ø°ÊÅØ‰∏ãÁöÑÊéíÁâà‰ºòÂåñ</li>
                                    </ul>
                                </div>
                                
                                <div>
                                    <p className="font-medium">v1.2.3-fix</p>
                                    <p className="text-xs text-neutral-500 mt-1">2025-04-23</p>
                                    <ul className="mt-2 text-xs text-neutral-500 list-disc pl-4 space-y-1">
                                        <li>ÂΩªÂ∫ïËß£ÂÜ≥‰ΩéÁâàÊú¨Á≥ªÁªüÈÄÇÈÖçÈóÆÈ¢òÔºàÁïåÈù¢Ê†∑ÂºèÁº∫Â§±Á≠âÔºâ</li>
                                        <li>ÂÖºÂÆπ‰∫ÜÊõ¥Â§öËÆæÂ§á</li>
                                        <li>ÊîØÊåÅÂø´ÈÄü‰øÆÊîπÂ∫ìÂ≠ò</li>
                                        <li>Ê∑ªÂä†Â∞èÂΩ©ËõãÔºàÂèåÂáªÊ≥®Ê∞¥Êó∂ÁöÑÂô®ÂÖ∑ÂõæÂÉèÔºå‰ºöÊúâÂä®ÁîªÔºâ</li>
                                    </ul>
                                </div>
                                
                                <div>
                                    <p className="font-medium">v1.2.0</p>
                                    <p className="text-xs text-neutral-500 mt-1">2025-04-12</p>
                                    <ul className="mt-2 text-xs text-neutral-500 list-disc pl-4 space-y-1">
                                        <li>Êñ∞Â¢ûÊµÅÈÄüÊòæÁ§∫</li>
                                        <li>Ê≥®Ê∞¥Ê≠•È™§Ê∑ªÂä†ÂàÜÈöîÁ∫øÊòæÁ§∫</li>
                                        <li>Á¨îËÆ∞Êñ∞Â¢ûÂíñÂï°Ë±ÜÂíåÂô®ÂÖ∑ÂàÜÁ±ª</li>
                                        <li>Êñ∞Â¢û Peter 2024 ÂíñÂï°Ë±ÜÊ¶úÂçïÂíåÁ≤æÂáÜË∑≥ËΩ¨ÂäüËÉΩ</li>
                                        <li>ÊúÄÂêéÊ≥®Ê∞¥Èò∂ÊÆµÊó∂ÊîØÊåÅË∑≥Ëøá</li>
                                        <li>Êñ∞Â¢û10Ê¨æÁ£®Ë±ÜÊú∫ÊîØÊåÅ</li>
                                        <li>‰øÆÂ§çËá™ÂÆö‰πâÊñπÊ°àÊ∞¥ÈáèËÆ°ÁÆóÈóÆÈ¢òÁ≠â</li>
                                    </ul>
                                </div>
                                
                                <div className="pb-10">
                                    <a 
                                        href="https://github.com/chu3/brew-guide/releases" 
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="text-xs text-neutral-500 hover:text-neutral-700 dark:hover:text-neutral-300 transition-colors"
                                    >
                                        Êü•ÁúãÊõ¥Â§öÂéÜÂè≤ÁâàÊú¨ËÆ∞ÂΩï ‚Üí
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div className="absolute bottom-0 left-0 w-full h-[120px] bg-gradient-to-t from-neutral-50 dark:from-neutral-900 to-transparent z-[1] pointer-events-none" />
                    </motion.div>
                );
            default:
                return null;
        }
    };

    return (
        <div className="relative flex min-h-full w-full flex-col">
            {/* ÂÜÖÂÆπÂå∫Âüü */}
            <AnimatePresence mode="wait">
                {showContent && (
                    <motion.div 
                        className="flex-1 flex items-center justify-center w-full pb-28"
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        transition={{ duration: 0.3 }}
                    >
                        {renderTabContent()}
                    </motion.div>
                )}
            </AnimatePresence>

            {/* Â∑¶‰∏ãËßíÁöÑAPPÁÆÄ‰ªã */}
            <div className="absolute bottom-8 left-6 max-w-[200px] pb-safe-bottom">
                <div className="h-[20px] mb-6">
                    {showContent ? (
                        <AnimatePresence mode="wait">
                            <motion.p
                                key={imageIndex}
                                className="text-xs text-neutral-500 dark:text-neutral-400"
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                exit={{ opacity: 0 }}
                                transition={{ duration: 0.2 }}
                            >
                                {activeTab === 'intro' ? descriptions[imageIndex] : ''}
                            </motion.p>
                        </AnimatePresence>
                    ) : (
                        <p className="text-xs text-neutral-500 dark:text-neutral-400">
                            Brew Guide ‰∏ÄÁ´ôÂºèÁÆ°ÁêÜÂô®ÂÖ∑„ÄÅÊñπÊ°à„ÄÅÂíñÂï°Ë±Ü‰ª•ÂèäÁ¨îËÆ∞ÁöÑÂ∞èÂ∑•ÂÖ∑„ÄÇ
                        </p>
                    )}
                </div>
                <p className="mt-2 text-xs text-neutral-500 dark:text-neutral-400 flex gap-5">
                    <a 
                        onClick={() => handleTabClick('intro')} 
                        className={`cursor-pointer relative ${showContent ? '' : 'underline'}`}
                    >
                        {showContent ? (
                            <>
                                <span className={`transition-opacity duration-300 ${activeTab === 'intro' ? 'opacity-100' : 'opacity-0'}`}>[</span>
                                ‰ªãÁªç
                                <span className={`transition-opacity duration-300 ${activeTab === 'intro' ? 'opacity-100' : 'opacity-0'}`}>]</span>
                            </>
                        ) : 'ÂâçÂæÄ'}
                    </a>
                    {showContent && (
                        <>
                            <motion.a 
                                onClick={() => handleTabClick('download')}
                                className="cursor-pointer relative"
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                transition={{ delay: 0.1, duration: 0.3 }}
                            >
                                <span className={`transition-opacity duration-300 ${activeTab === 'download' ? 'opacity-100' : 'opacity-0'}`}>[</span>
                                ‰∏ãËΩΩ
                                <span className={`transition-opacity duration-300 ${activeTab === 'download' ? 'opacity-100' : 'opacity-0'}`}>]</span>
                            </motion.a>
                            <motion.a 
                                onClick={() => handleTabClick('changelog')}
                                className="cursor-pointer relative"
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                transition={{ delay: 0.2, duration: 0.3 }}
                            >
                                <span className={`transition-opacity duration-300 ${activeTab === 'changelog' ? 'opacity-100' : 'opacity-0'}`}>[</span>
                                Êõ¥Êñ∞ËÆ∞ÂΩï
                                <span className={`transition-opacity duration-300 ${activeTab === 'changelog' ? 'opacity-100' : 'opacity-0'}`}>]</span>
                            </motion.a>
                        </>
                    )}
                </p>
            </div>
        </div>
    )
} 